<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÉ‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Debugging Log)</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- React + ReactDOM UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <style>
    body { font-family: 'Noto Sans Thai', 'Inter', sans-serif; background-color: #f3f4f6; }

    /* Uiverse.io Button */
    .button {
      line-height: 1;
      text-decoration: none;
      display: inline-flex;
      border: none;
      cursor: pointer;
      align-items: center;
      gap: 0.75rem;
      background-color: var(--clr);
      color: #fff;
      border-radius: 10rem;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      padding-left: 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background-color 0.3s;
    }

    .button__icon-wrapper {
      flex-shrink: 0;
      width: 25px;
      height: 25px;
      position: relative;
      color: var(--clr);
      background-color: #fff;
      border-radius: 50%;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .button:hover {
      background-color: #000;
    }

    .button:hover .button__icon-wrapper {
      color: #000;
    }

    .button__icon-svg--copy {
      position: absolute;
      transform: translate(-150%, 150%);
    }

    .button:hover .button__icon-svg:first-child {
      transition: transform 0.3s ease-in-out;
      transform: translate(150%, -150%);
    }

    .button:hover .button__icon-svg--copy {
      transition: transform 0.3s ease-in-out 0.1s;
      transform: translate(0);
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const firebaseConfig = {
    apiKey: "AIzaSyALtj2HWW3bZCPhxJWCaHBlZ9v6r6lneSU",
    authDomain: "phin-8f61c.firebaseapp.com",
    databaseURL: "https://phin-8f61c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "phin-8f61c",
    storageBucket: "phin-8f61c.firebasestorage.app",
    messagingSenderId: "819876335927",
    appId: "1:819876335927:web:7ad4655d717d8cde740ab2",
    measurementId: "G-5CYQ3532LJ"
  };

  firebase.initializeApp(firebaseConfig);
  const analytics = firebase.analytics();
  const db = firebase.firestore();

  const App = () => {
    const [groupName, setGroupName] = React.useState("");
    const [groupEntered, setGroupEntered] = React.useState(false);
    const [logs, setLogs] = React.useState([]);
    const [form, setForm] = React.useState({
      mission_name: "",
      expected_result: "",
      actual_problem: "",
      bug_type: "‡∏ö‡∏±‡πä‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á/‡∏ï‡∏£‡∏£‡∏Å‡∏∞",
      solution_action: "",
      responsible_member: "",
      reflection: "",
    });
    const [msg, setMsg] = React.useState("");
    const [loading, setLoading] = React.useState(false);
    const [editId, setEditId] = React.useState(null);

    const listenLogs = (group) => {
      setLoading(true);
      const ref = db.collection("artifacts").doc("KKRHub")
                    .collection("groups").doc(group)
                    .collection("debugging_logs")
                    .orderBy("timestamp", "desc");
      ref.onSnapshot(snapshot => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setLogs(data);
        setLoading(false);
      }, err => {
        console.error(err);
        setMsg("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Firebase: " + err.message);
        setLoading(false);
      });
    };

    const handleGroupEnter = (e) => {
      e.preventDefault();
      if (!groupName.trim()) return;
      setGroupEntered(true);
      listenLogs(groupName.trim());
    };

    const handleGoBack = () => {
      setGroupEntered(false);
      setLogs([]);
      setGroupName("");
      setEditId(null);
    };

    const handleChange = (e) => setForm({...form, [e.target.name]: e.target.value});

    const handleSubmit = async (e) => {
      e.preventDefault();
      if (!groupName) return;
      setMsg(editId ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï..." : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
      try {
        if(editId){
          await db.collection("artifacts").doc("KKRHub")
            .collection("groups").doc(groupName)
            .collection("debugging_logs").doc(editId)
            .update({
              ...form,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
          setMsg("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          setEditId(null);
        } else {
          await db.collection("artifacts").doc("KKRHub")
            .collection("groups").doc(groupName)
            .collection("debugging_logs")
            .add({
              ...form,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
          setMsg("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }
        setForm({
          mission_name: "",
          expected_result: "",
          actual_problem: "",
          bug_type: "‡∏ö‡∏±‡πä‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á/‡∏ï‡∏£‡∏£‡∏Å‡∏∞",
          solution_action: "",
          responsible_member: "",
          reflection: "",
        });
        setTimeout(() => setMsg(""), 3000);
      } catch (err) {
        setMsg("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    };

    const handleEdit = (log) => {
      setForm({...log});
      setEditId(log.id);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    if (!groupEntered) {
      return (
        <div className="h-screen flex items-center justify-center">
          <form onSubmit={handleGroupEnter} className="bg-white p-8 rounded-xl shadow space-y-4 w-80 text-center">
            <h1 className="text-2xl font-bold text-indigo-700 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°ü§ù</h1>
            <input
              type="text"
              placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°"
              value={groupName}
              onChange={e => setGroupName(e.target.value)}
              className="w-full p-2 border rounded mb-6"
              required
            />
            <button type="submit" className="button" style={{"--clr": "#7808d0"}}>
              <span className="button__icon-wrapper">
                <svg viewBox="0 0 14 15" fill="none" xmlns="http://www.w3.org/2000/svg" className="button__icon-svg" width="10">
                  <path d="M13.376 11.552l-.264-10.44-10.44-.24.024 2.28 6.96-.048L.2 12.56l1.488 1.488 9.432-9.432-.048 6.912 2.304.024z" fill="currentColor"></path>
                </svg>
                <svg viewBox="0 0 14 15" fill="none" width="10" xmlns="http://www.w3.org/2000/svg" className="button__icon-svg button__icon-svg--copy">
                  <path d="M13.376 11.552l-.264-10.44-10.44-.24.024 2.28 6.96-.048L.2 12.56l1.488 1.488 9.432-9.432-.048 6.912 2.304.024z" fill="currentColor"></path>
                </svg>
              </span>
              ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </form>
        </div>
      );
    }

    if (loading) return <div className="h-screen flex items-center justify-center text-gray-500 text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>;

    return (
      <div className="max-w-3xl mx-auto p-6">
        <header className="bg-white p-4 rounded-xl shadow mb-6 text-center">
          <h1 className="text-2xl font-bold text-indigo-700">‡πÉ‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Debugging Log)</h1>
          <p className="text-sm text-gray-500 mt-1">
            ‡∏Å‡∏•‡∏∏‡πà‡∏°: {groupName} 
            <button onClick={handleGoBack} className="ml-2 px-2 py-1 bg-yellow-300 rounded hover:bg-yellow-400 text-xs">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
          </p>
        </header>

        {msg && <div className={`p-3 mb-4 text-sm rounded-lg ${msg.includes("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") ? "bg-red-100 text-red-700":"bg-green-100 text-green-700"}`}>{msg}</div>}

        <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow mb-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏¢‡πà‡∏≠‡∏¢ (Mission)</label>
            <input
              name="mission_name"
              value={form.mission_name}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢ 90 ‡∏≠‡∏á‡∏®‡∏≤ (Turn left 90¬∞)"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à (Expected Result)</label>
            <textarea
              name="expected_result"
              value={form.expected_result}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡∏´‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á (Car turns left and stops)"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-red-600">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á (Actual Problem) *</label>
            <textarea
              name="actual_problem"
              value={form.actual_problem}
              onChange={handleChange}
              className="w-full p-2 border rounded border-red-300"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ñ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏î‡∏µ (Car didn't turn correctly)"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡πä‡∏Å (Bug Type)</label>
            <select
              name="bug_type"
              value={form.bug_type}
              onChange={handleChange}
              className="w-full p-2 border rounded"
            >
              <option>‡∏ö‡∏±‡πä‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á/‡∏ï‡∏£‡∏£‡∏Å‡∏∞ (Logic Bug)</option>
              <option>‡∏ö‡∏±‡πä‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå (Physical/Robot Bug)</option>
              <option>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ú‡∏¥‡∏î (Misunderstanding)</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Solution)</label>
            <textarea
              name="solution_action"
              value={form.solution_action}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡πÄ‡∏õ‡πá‡∏ô 85 ‡∏≠‡∏á‡∏®‡∏≤ (Adjust turn angle to 85¬∞)"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ (Responsible Member)</label>
            <input
              name="responsible_member"
              value={form.responsible_member}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏ô‡∏µ‡πâ"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (Reflection)</label>
            <textarea
              name="reflection"
              value={form.reflection}
              onChange={handleChange}
              className="w-full p-2 border rounded"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (Adjusting angle is crucial for accuracy)"
              required
            />
          </div>
          <button
            type="submit"
            className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700"
          >
            {editId ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Save Edit)" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Save Log)"}
          </button>
        </form>

        <section>
          <h2 className="text-lg font-semibold mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ({logs.length})</h2>
          {logs.length === 0 ? (
            <p className="bg-white p-4 rounded shadow text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
          ) : (
            logs.map(log => (
              <div key={log.id} className="bg-white p-4 rounded-xl shadow mb-3 border-l-4 border-indigo-500 flex justify-between items-start">
                <div>
                  <p className="font-bold text-indigo-700">{log.mission_name}</p>
                  <p className="text-sm text-gray-700 mt-1"><b>‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</b> {log.actual_problem}</p>
                  <p className="text-sm text-gray-700"><b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</b> {log.solution_action}</p>
                  <p className="text-xs text-gray-400 mt-2">‡πÄ‡∏ß‡∏•‡∏≤: {log.timestamp?.toDate?.()?.toLocaleString('th-TH') ?? '‚Äî'}</p>
                </div>
                <button onClick={() => handleEdit(log)} className="ml-3 px-2 py-1 bg-green-300 rounded hover:bg-green-400 text-xs">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              </div>
            ))
          )}
        </section>
      </div>
    );
  };

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
